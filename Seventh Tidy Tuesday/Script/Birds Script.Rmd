---
title: "Birds"
author: "Nicole Ayala"
date: "`r Sys.Date()`"
output: 
    html_document:
      toc: TRUE
      toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Organizing the Data & Loading the Libraries
```{r}
### Loading in the Libraries ###
library(tidyverse)
library(tidytuesdayR)
library(svglite)
library(colorspace)
library(geojsonio)
library(sf)
library(broom) 
library(rgeos)
library(scico)

### Loading the Data ###

public <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-01-10/PFW_2021_public.csv')

### Wrangling the Data ###
df <- public %>% 
  filter(Year == 2020) %>% # only want year 2020
  group_by(Year, subnational1_code) %>%  # grouping state w/ year
  summarise(count = n_distinct(species_code)) %>% # counting number of distinct bird species in each state
  ungroup() %>% # fixing the group by filtering out unnecessary data
  filter(grepl("US-", subnational1_code)) %>% # looking for matches with US- only, no CA-
  mutate(state = gsub("US-", "", subnational1_code)) %>% # need to change the state names (global substitutions)
  mutate(state = state.name[match(state, state.abb)]) %>% # need to match state name with actual abbreviation
  mutate(state = replace(state, subnational1_code == "US-DC", "District of Columbia")) # specific example would be D.C. in the US

## Last Filtering Attempt for Bird DF Total ###
df_total <- public %>% # piping to same filters as previously done
  filter(Year == 2020) %>% # only want year 2020
  filter(grepl("US-", subnational1_code)) %>% # need to make all the data follow US- format, ignore the rest of the data
  summarise(count = n_distinct(species_code)) # counting distinct species of birds
  
### Time to Make the Honey Comb/Hexagon Shaped US ###
hex_states <- geojson_read("https://raw.githubusercontent.com/holtzy/R-graph-gallery/master/DATA/us_states_hexgrid.geojson.json", what = "sp") # used what I found on the web for the hexagon shapes


hex_states@data = hex_states@data %>% # pipe to itself
  mutate(google_name = gsub(" \\(United States\\)", "", google_name)) # learned this from andrew hill @ carto.com, adds the abbreviations for each state


hex_states_new <- tidy(hex_states, region = "google_name") # creating a data frame with google's abbreviations of US states to make it more accurate

### I was struggling with the left join so I let it be, I think it worked out ###
df_states <- hex_states_new %>% 
  left_join(. , df, by = c("id" = "state")) %>%  # doing a left join of state name being defined within a hexagon, matching it to id data
  mutate(id = state.abb[match(id, state.name)]) #matching state name to state abbreviation
  
# fixing up DC data (state abbreviation for VA)
df_states$id[df_states$group == "District of Columbia.1"] <- "DC"

### Ensuring Labels are Correctly Formatted for States ###
labels <- cbind.data.frame(data.frame(gCentroid(hex_states, byid = TRUE), id = hex_states@data$iso3166_2))

# final left join to join id to states, ensuring abbreviations match up with id in the data 
df_total <- df_states %>% 
  left_join(. , labels, by = "id")
```
### Time to Plot

```{r}
df_total %>% 
  ggplot () +
  geom_polygon(aes(x = long, y = lat, group = group, fill = count), color="#000000", linewidth = 0.5) +
  scale_fill_scico(palette = "grayC", direction = 1) +
  coord_map(clip = "off") +
  geom_text(aes(x = x, y = y, label = id, color = count <= 70), family = font1, size = 3, show.legend = FALSE) +
  scale_color_manual(values = c("#FFFFFF", "#000000")) +
  scale_y_continuous(limits = c(25, 57)) +
  #annotate(geom = "text", x = -104, y = 54, label = "331 unique species of birds observed, which is less\nthan half of the potential bird species found in the U.S.", hjust = "center", family = font2, size = 3, color = "#000000") +
  annotate(geom = "text", x = -136, y = 37, label = "6 bird\nspecies", hjust = "left", family = font2, size = 3, color = "#000000") +
  annotate(geom = "segment", x = -136, y = 35, xend = -136, yend = 33, size = 0.4,  arrow = arrow(length = unit(1.5, "mm")), color = "#000000") +
  annotate(geom = "text", x = -122, y = 27, label = "139 bird\nspecies", hjust = "left", family = font2, size = 3, color = "#000000") +
  annotate(geom = "segment", x = -116, y = 28.5, xend = -113, yend = 28.5, size = 0.4,  arrow = arrow(length = unit(1.5, "mm")), color = "#000000") +
  theme_void() +
  theme(plot.title = element_text(family = font1, size = 29, hjust = 0.5, face = "bold"),
        plot.title.position = "plot",
        plot.subtitle = element_text(family = font1, size = 11, hjust = 0.5, lineheight = 1.1),
        plot.caption.position = "plot",
        plot.caption = element_text(size = 9, family = font1, color = "#000000", hjust = 0.5),
        legend.position = c(0.5, 0.85),
        legend.direction = "horizontal",
        legend.title = element_blank(),
        legend.text = element_text(size = 8, family = font1, color = "#000000"),
        legend.key.height = unit(0.25, 'cm'),
        legend.key.width = unit(1.25, 'cm'),
        plot.margin = unit(c(0, 0.25, 0, 0.25), "cm"),
        plot.background = element_rect(color = "#FFFFFF", fill = "#FFFFFF")) +
  labs(title = "BIRD SPECIES",
       subtitle = "The total number of unique bird species observed by volunteers\nin 2021 by state (and DC) as a part of the FeederWatch Program.\n",
       caption = "\n\n\n#TidyTuesday | Data: FeederWatch.org | Design: Ryan Hart")

### SAVE THE PLOT ###

ggsave(here("Seventh Tidy Tuesday","Output","7thTidyTuesdayPlot.png"),# names and saves ggplot
       width = 15, height = 10)# adjust size of graph in inches
```
